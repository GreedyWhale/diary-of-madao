---
title: '个人博客-项目搭建'
labels: ['React.js', 'Next.js', 'Prisma']
introduction: '这是我实现个人博客项目的第一篇笔记，记录了项目搭建的过程'
---

## 概要: 

由于一些不可抗力我决定将自己学习笔记从国内的平台中迁移出来，第一次迁移我选择将项目部署在**GitHub Pages**上，使用体验很不错，后来学习中有一个课程是实现一个博客系统，里面有用到一些后端和数据库的知识，正好我也想重写之前的笔记，于是就做了这个项目。

其中涉及到的技术有：

1. React.js
2. Next.js
3. Prisma
4. PostgreSQL
5. Docker
6. TypeScript

在写这篇笔记的时候，项目已经写的差不多了，说实话使用起来还没**GitHub Pages**好用，但是做都做出来了...

## 环境：

- macOS: 12.0.1
- Node.js: v14.18.1
- Next.js: 12.0.4

## 参考：

- [Next.js](https://nextjs.org/)
- [dockerhub-postgres](https://hub.docker.com/_/postgres)
- [Prisma](https://www.prisma.io/)
- [完整代码](https://github.com/GreedyWhale/code-examples/tree/33ed3772821144afd619f813b7f409fa43c27bf9)


#### 一. 项目初始化

1. 使用Next.js初始化项目

    ```
    yarn create next-app --typescript .
    ```
    
2. 支持scss

    ```
    yarn add sass -D
    ```
3. 添加eslint规则

    这一步可有可无，因为Next.js自带了eslint配置。
    
    **注意**: 这里有一个坑，如果你选择自己配置eslint，在我当前使用的这个Next.js(v12.0.4)中，不支持eslint 8，所以当你配置完成后记得检查一下eslint版本。
    
    > 参考[#29951](https://github.com/vercel/next.js/discussions/29951)

    我使用了[XO](https://github.com/xojs/xo)规则，加上自己的一些修改。
    
    
    自定义配置步骤：
    
    1. `yarn eslint --init`
    
        执行上面命令会有一些eslint的选项，选择完成等npm下载完成，如果你用的是yarn，建议删除node_modules目录，把所有包都重新下载一遍。
    
    2. 将eslint版本降回7
    
        `yarn add eslint@"<8.0.0" -D`
        
    3. 在.eslintrc.js中的extends属性中添加next/core-web-vitals，删除多余的.eslintrc.json文件
    
    4. 根据实际情况进行配置，我的配置参考: 
    
        [最终配置](https://github.com/GreedyWhale/code-examples/blob/main/blog-example/.eslintrc.js)
    
    
#### 二. 制作docker容器

1. 确保已经安装了docker

    ```
    docker -v // 检查docker的版本
    ```
2. 创建postgres容器

    ```
    docker run -d --name blog-example -e POSTGRES_PASSWORD=blogExample -e POSTGRES_USER=admin -e POSTGRES_DB=admin -v $PWD/blog-example-data:/var/lib/postgresql/data -p 5432:5432 postgres:latest
    ```
    
    参数说明：
    
    - -d: 在后台运行
    - --name: 容器的名字
    - -e: 用来设置环境变量
      - POSTGRES_PASSWORD: 登录postgres的密码
      - POSTGRES_USER: 登录postgres的用户名
      - POSTGRES_DB: 首次启动时创建的默认数据库名
    - -v: 设置数据卷，本地目录:容器目录
      - 这句命令的意思是将容器的目录映射到本地目录，这样做的好处是可以让数据持久化，在指定的本地目录里面新增文件可以同步到容器目录下，同样的在容器里面新增文件也可以同步到本地目录下，当容器被删除挂载的目录及目录里面的文件不会删除。
    - -p: 指定端口映射，访问本机的端口会自动映射到容器的这个端口
    - postgres:latest 指定容器的镜像为postgres最新版
    
    - 执行`docker ps -a`查看刚刚创建的容器
    
        ![WX20211124-110001@2x_1637723372418.png](/static/images/posts/WX20211124-110001@2x_1637723372418.png "WX20211124-110001@2x_1637723372418.png")
        
      如果容器状态是 up 那么证明成功了
      
      如果没有成功的启动，可以输入`docker logs 容器id --follow`来查看容器的日志
    
#### 三. 安装 Prisma

1. `yarn add prisma -D`
2. `yarn prisma init`

    执行完上面两个命令后，项目根目录会多出一个`prisma`的目录和.env文件
3. 连接数据库

    - prisma/schema.prisma
    
        ```
        datasource db {
          provider = "postgresql"
          url      = env("DATABASE_URL")
        }
        ```
        
    - .env
    
        ```
        # 数据库地址
        # admin 创建数据库时的用户名
        # blogExample 创建数据库时的密码
        # 5432 创建数据库时映射的端口
        # development 要连接的数据库名，不存在会自动创建
        DATABASE_URL="postgresql://admin:blogExample@localhost:5432/development?schema=public"
        ```
        
4. 创建一张数据表测试

    - prisma/schema.prisma
    
        ```
        model User {
          id   Int    @id @default(autoincrement())
          name String @db.VarChar(255) @unique
        }
        ```
        
        修饰符可以在文档[Prisma schema reference](https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference)中找到含义，这里就不再细说。
        
5. 将刚刚写的User模型映射到数据库中

    `yarn prisma migrate dev --name test_create_table`
    
    **注意**: 假如这一步报Error: P1000的错误，请检查创建容器的时候密码是不是用了特殊字符，我第一次使用的是*blog-example*作为密码，无法登录，改为*blogExample*就可以了，不知道是不是这个原因。

6. 安装prisma client

    `yarn add @prisma/client`
 
7. 查看创建的数据表

    1. `docker ps -a` 获取容器id
    2. `docker exec -it 容器id bash`进入容器
    3. `psql -U admin` 连接数据库
    4. `\l` 查看数据库

    ![WX20211124-130758@2x_1637730490532.png](/static/images/posts/WX20211124-130758@2x_1637730490532.png "WX20211124-130758@2x_1637730490532.png")
    
    5. `\c development` 进入development数据库
    6. `\dt` 查看所有数据表
    
 8. 也可以使用Prisma 提供的图形界面来操作数据库，[下载地址](https://www.prisma.io/studio)

#### 五. 关于prisma client的疑问

上面步骤中有一步是安装`@prisma/client`，根据文档描述，安装它会自动执行`prisma generate`命令，这个命令的作用是根据当前项目的*prisma/schema.prisma*文件生成对应的客户端版本，可以在*node_modules/.prisma/client*中看到，用上面的例子来说，可以在*node_modules/.prisma/client/index.d.ts*中找到如下类型声明：

``` typescript
export type User = {
  id: number
  name: string
}
```

这个类型声明就是根据*prisma/schema.prisma*里的用户表生成的。

经过测试不管是在User表中新增一个字段，还是直接新增一个表，只要执行了`prisma migrate`命令后，它就会更新的，文档有提到如果以后修改了**Prisma schema**需要手动调用一下`prisma generate`命令，不过我现在还不太清楚怎样才算是修改**Prisma schema**，所以留一个疑问在这里。


好了，基础的项目搭建就完成了，下一个笔记记录一下如何设计博客中需要的表。